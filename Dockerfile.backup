FROM eclipse-temurin:21-jdk

# URL por defecto del pack de servidor ATM10 (puedes cambiarlo al construir)
ARG SERVER_PACK_URL=https://mediafilez.forgecdn.net/files/6921/537/ServerFiles-4.10.zip

# Server HOME: directorio donde se descargará el pack del servidor

ENV SERVER_HOME=/data \
    BACKUP_DIR=/data/backups


RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    bash \
    ca-certificates \
    curl \
    jq \
    tzdata \
    unzip \
    wget \
    rsync \
    zip \
    tini \
 && rm -rf /var/lib/apt/lists/*

# Create non-root user (let the system choose a free UID to avoid conflicts)
RUN useradd -m -U -d /home/minecraft -s /bin/bash minecraft

RUN mkdir -p ${SERVER_HOME} /usr/local/bin \
 && chown -R minecraft:minecraft ${SERVER_HOME}

VOLUME ["${SERVER_HOME}"]

# Descargar y descomprimir el pack del servidor ATM10 en build
RUN echo "Descargando pack de servidor desde ${SERVER_PACK_URL}" \
 && wget -O /tmp/pack.zip "${SERVER_PACK_URL}" \
 && unzip -q /tmp/pack.zip -d "${SERVER_HOME}" \
 && rm -f /tmp/pack.zip \
 && if [ -f "${SERVER_HOME}/startserver.sh" ]; then chmod +x "${SERVER_HOME}/startserver.sh"; fi \
 && if [ -f "${SERVER_HOME}/run.sh" ]; then chmod +x "${SERVER_HOME}/run.sh"; fi \
 && chown -R minecraft:minecraft "${SERVER_HOME}"


WORKDIR ${SERVER_HOME}
RUN java -jar neoforge*.jar --installServer

# Copiar script de ejecución (CMD)
# COPY run-server.sh /usr/local/bin/run-server.sh
# RUN chmod +x /usr/local/bin/run-server.sh

EXPOSE 25565 25575


WORKDIR ${DATA_DIR:-/data}

USER minecraft

ENTRYPOINT ["/usr/bin/tini", "-g", "--"]
# CMD ["/usr/local/bin/run-server.sh"]


